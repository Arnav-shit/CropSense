<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CropSense Data Uploader</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7fbf8;
        color: #1e4029;
        overflow-x: hidden;
    }

    /* Custom scrollbar for a cleaner look */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #e2e8f0;
    }

    ::-webkit-scrollbar-thumb {
        background: #1e4029;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #38a169;
    }

    .button-glow {
        box-shadow: 0 4px 6px rgba(52, 211, 153, 0.4), 0 1px 3px rgba(52, 211, 153, 0.2);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .button-glow:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 10px rgba(52, 211, 153, 0.6), 0 3px 6px rgba(52, 211, 153, 0.3);
    }
</style>

<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">
    <main class="flex-grow flex items-center justify-center py-16 px-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-green-200 max-w-2xl w-full text-center">
            <h1 class="text-3xl font-bold text-green-700 mb-4">Data Uploader</h1>
            <p class="text-gray-600 mb-8">Upload images and sensor data to contribute to the CropSense AI model.</p>

            <form id="upload-form" class="space-y-6">
                <div>
                    <label for="image-upload" class="block text-lg font-medium text-gray-700 mb-2">
                        Upload Crop Image
                    </label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-green-50 file:text-green-700
                        hover:file:bg-green-100">
                </div>

                <div id="image-preview-container" class="mt-4 hidden">
                    <img id="image-preview" src="#" alt="Image Preview"
                        class="w-full h-auto rounded-lg shadow-inner border border-gray-300">
                </div>

                <div>
                    <label for="sensor-data" class="block text-lg font-medium text-gray-700 mb-2">
                        Simulated Hyperspectral Data
                    </label>
                    <textarea id="sensor-data" rows="4"
                        class="w-full rounded-lg border-2 border-green-300 p-3 text-gray-700 focus:outline-none focus:border-green-500 transition-colors"
                        placeholder="e.g., {'ndvi': 0.85, 'chlorophyll': 72, 'moisture': 45}"></textarea>
                </div>

                <button type="submit" id="save-button"
                    class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-full button-glow disabled:opacity-50 disabled:cursor-not-allowed">
                    Save to Database
                </button>
            </form>

            <div id="status-message" class="mt-6 text-sm font-medium"></div>

            <!-- Display User ID to allow for collaboration -->
            <div id="user-info" class="mt-8 p-4 bg-gray-100 rounded-lg text-left text-sm text-gray-500">
                <p><strong>Your User ID:</strong> <span id="user-id">Loading...</span></p>
                <p>This ID is used to manage your uploaded data.</p>
            </div>

            <a href="https://arnav-shit.github.io/CropSense/"
                class="inline-block mt-8 text-green-700 hover:text-green-500 transition-colors">
                &larr; Back to Home
            </a>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-green-800 text-white py-6 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <p class="text-gray-400">&copy; 2025 CropSense. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
</body>

<script>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, collection, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

    // Set Firebase debug logs
    setLogLevel('debug');

    let db, auth;
    let userId;

    const urlParams = new URLSearchParams(window.location.search);
    const appIdFromUrl = urlParams.get('appId');
    const authTokenFromUrl = urlParams.get('authToken');

    const imageUploadInput = document.getElementById('image-upload');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const sensorDataTextarea = document.getElementById('sensor-data');
    const uploadForm = document.getElementById('upload-form');
    const statusMessage = document.getElementById('status-message');
    const userIdSpan = document.getElementById('user-id');

    // Initialize Firebase on page load
    window.addEventListener('load', async () => {
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        if (Object.keys(firebaseConfig).length === 0) {
            statusMessage.textContent = 'Firebase config not found.';
            statusMessage.className = 'mt-6 text-red-500 font-bold';
            return;
        }

        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // Listen for auth state changes to get the user ID
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdSpan.textContent = userId;
                statusMessage.textContent = 'Authenticated successfully.';
                statusMessage.className = 'mt-6 text-green-500 font-bold';
            } else {
                statusMessage.textContent = 'Not authenticated. Signing in anonymously...';
                statusMessage.className = 'mt-6 text-orange-500 font-bold';
                try {
                    if (authTokenFromUrl) {
                        await signInWithCustomToken(auth, authTokenFromUrl);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during authentication:", error);
                    statusMessage.textContent = 'Authentication failed. Please try again.';
                    statusMessage.className = 'mt-6 text-red-500 font-bold';
                }
            }
        });
    });

    // Event listener to show a preview of the selected image
    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            imagePreviewContainer.classList.add('hidden');
        }
    });

    // Form submission handler
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!db || !userId) {
            statusMessage.textContent = 'Database not ready. Please wait...';
            statusMessage.className = 'mt-6 text-orange-500 font-bold';
            return;
        }

        const imageFile = imageUploadInput.files[0];
        const sensorData = sensorDataTextarea.value.trim();

        if (!imageFile || !sensorData) {
            statusMessage.textContent = 'Please upload an image and enter sensor data.';
            statusMessage.className = 'mt-6 text-red-500 font-bold';
            return;
        }

        statusMessage.textContent = 'Uploading data...';
        statusMessage.className = 'mt-6 text-blue-500 font-bold';
        const saveButton = document.getElementById('save-button');
        saveButton.disabled = true;

        const reader = new FileReader();
        reader.onload = async (event) => {
            const base64Image = event.target.result;

            try {
                // Create a document to store in the Firestore collection
                const docData = {
                    image: base64Image,
                    hyperspectral_data: sensorData,
                    timestamp: new Date().toISOString(),
                    userId: userId
                };

                // For a multi-user app, this collection should be public
                const app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = `artifacts/${app_id}/public/data/hyperspectral_images`;

                await addDoc(collection(db, collectionPath), docData);

                statusMessage.textContent = 'Data uploaded successfully!';
                statusMessage.className = 'mt-6 text-green-500 font-bold';
                uploadForm.reset();
                imagePreviewContainer.classList.add('hidden');

            } catch (error) {
                console.error("Error adding document:", error);
                statusMessage.textContent = `Error uploading data: ${error.message}`;
                statusMessage.className = 'mt-6 text-red-500 font-bold';
            } finally {
                saveButton.disabled = false;
            }
        };
        reader.readAsDataURL(imageFile);
    });
</script>

</html>